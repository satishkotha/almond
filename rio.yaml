schemaVersion: 2.0

timeout: 60

machine:
  env:
    BASE_VERSION: 0.8.2
    RUNTIME_JDK_VERSION: 11
    SBT_OPTS: -XX:MaxMetaspaceSize=4096M
    SCALA_VERSIONS: 2.12.8
    ALMOND_VERSION: 0.8.2

builds:
  - name: almond-0.8.2-publish
    branchName: 0.8.2
    build:
      template: buildozer:v4:publish
    package:
      release: true
      libraries: false
    finally:
      tag:
        expression: '0.0.1-${RIO_BUILD_NUMBER}'

  - name: almond-0.8.2-docker
    branchName: 0.8.2
    machine:
      env:
        DOCKER_REPO: '$(echo $GIT_URL | cut -d"/" -f1 | cut -d":" -f2)'
    build:
      template: buildozer:v4:publish
    package:
      dockerfile:
        - dockerfilePath: ./Dockerfile
          name: almond-oss-docker
          perApplication: false
          publish:
            # Publishes to the specified repos and to the Compute namespace.
            - repo: docker.apple.com/${DOCKER_REPO}/spark-almond-oss-kernel
      mirror:
        target: silkroad